<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DoSurvey-Ridham</title>
  <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"> -->
  <link rel="stylesheet" href="table.css">
  <link rel="stylesheet" href="navbar.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

  <style>
    body.blur {
      filter: blur(5px);
      /* Adjust the blur amount as needed */
      pointer-events: none;
    }
  </style>
</head>

<body>

  <div class="pathForm">
    <div class="navbar">
      <div class="title">
        <h3>They Think we Work For Them - LOL! </h3>
       </div>
    
       <div class="details">
        <a href="https://ridhamsawhney.com/" class="item">Contact Developer</a>
        
       </div>
    </div>
   
    
  </div>
 <br> 
  <div class="scriptContainer">
    <form action="/refresh" method="post">
      <button type="submit" class="pathButton">Refresh<span class="material-symbols-outlined">
        refresh
        </span></button>
    </form>
    <form id="scriptForm">
      <button type="button" onclick="runScript()" class="runScript">Run Script</button>
    </form>
  </div>
  



  <br>

  <div class="container">
    <div class="content-parent">
      <div>
        <br><br>
       
        <form action="/" method="post">
          <label for="path" class="pathLabel">Data File Path:</label>
          <input type="text" id="path" name="path" required>

          <button type="submit" class="pathButton">Load Ids</button>
        </form>
        
      </div>
      <br>
      <hr>
      <br>
      <h3>Loaded Ids:</h3>
      <div class="content">
        <% if (jsonData.length> 0) { %>
          <table>
            <tr>
              <th>Username</th>
              <th>Password</th>
            </tr>
            <tbody class="table-body">
              <% jsonData.forEach(data=> { %>
                <tr>
                  <td>
                    <%= data.id %>
                  </td>
                  <td>
                    <%= data.password %>
                  </td>
                </tr>
                <% }); %>
                  <% }%>
            </tbody>

          </table>
      </div>

    </div>

    <div class="traces">
      <div class="TraceTitle" id="TraceTitle">
        <h3 >Traces</h3>
      </div>
      <div id="resultTraces">
        <% if (TraceData.length > 0) { %>
          <table>
            <tr>
              <th>Username</th>
              <th>Password</th>
            </tr>
            <tbody class="table-body">
              <% TraceData.forEach(data => { %>
                <tr>
                  <td><%= data.user %></td>
                  <td><%= data.SurveyResults[0] %></td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        <% } %>
      </div>
    </div>
  </div>


  <script>
    function runScript() {
      const jsonData = `<%- JSON.stringify(jsonData) %>`;
      const dataToSent = getArraytoJson(JSON.parse(jsonData));
      // if(dataToSent.length==0){
      //   alert("Load some ids");
      //   return;
      // }
      document.body.classList.add('blur');
      fetch('/runScript', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(dataToSent)
      })
        .then(response => response.text())
        .then((message) => {
          if(message=="Access Denied : Contact Ridham." || message=="Load some ids.."){
            alert(message);
          }
          else{
            const Traceheading=document.getElementsByClassName("LastUpdate");
             if (Traceheading.length > 0) {
             // Remove all elements with the specified class name
              Array.from(Traceheading).forEach(function(element) {
                element.remove();
            });
            }

            const LastUpdate= document.createElement('h4');
            LastUpdate.classList.add('LastUpdate');
            LastUpdate.textContent=`[LastUpdated:${new Date().toLocaleString()}]`
            document.getElementById("TraceTitle").appendChild(LastUpdate)
            
            const accordionContainer = document.getElementById('resultTraces');
            accordionContainer.innerHTML='';
            message=JSON.parse(message);
            var count=1;
            message.forEach(item => {
            const accordionItem = createAccordionItem(`${count}. ${item.user}`, item.SurveyResults);
            accordionContainer.appendChild(accordionItem);
            count++;
          });
          alert("Successfully Saved Survey Traces  in FolderLocaiton [../Downloads/SurveyTraces]")

          }

          document.body.classList.remove('blur');
         
          //alert(message)
        })
        .catch(error => console.error('Error:', error));
    }

    function getArraytoJson(json) {

      var parentArray = [];
      json.forEach((jsonElement) => {
        var childArray = [];
        childArray.push(jsonElement.id)
        childArray.push(jsonElement.password);
        parentArray.push(childArray);
      })
      return parentArray;
    }
    
    function createAccordionItem(title, content) {
    var newDone=0;
    var alreadyDone=0;
    var passed=0;
    var failed=0;

    const accordionItem = document.createElement('details');
    accordionItem.classList.add('accordion');

    const summary = document.createElement('summary');
    
    summary.textContent = title;
    accordionItem.appendChild(summary);
   
    const list = document.createElement('ul');
    accordionItem.appendChild(list);
    content.forEach(element => {
        const elementDiv = document.createElement('li');
        elementDiv.classList.add('passed');
        if(element.includes("already"))
        {
          alreadyDone++;
        }
        else if(element.includes("done") && !element.includes("already"))
        {
          newDone++;
        }
        else{
          failed++;
          elementDiv.classList.add('failed');
        }
        elementDiv.textContent = element;
        list.appendChild(elementDiv);
      });
      if((alreadyDone+newDone)==5)
      summary.textContent=title+` [Already Done:${alreadyDone} , Newly Done:${newDone} , Passed : ${alreadyDone+newDone}] `
      else{
        summary.textContent=title+` [Already Done:${alreadyDone} , Newly Done:${newDone} , Passed : ${alreadyDone+newDone}] , Failed : ${failed}] `
        accordionItem.classList.add('error');
      }

      

    return accordionItem;
  }
  
  </script>

</body>

</html>