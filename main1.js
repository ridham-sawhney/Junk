const express=require("express"),{fork:e}=require("child_process"),axios=require("axios"),fs=require("fs").promises,{Builder:s,By:a,until:t,WebDriverWait:r}=require("selenium-webdriver"),moment=require("moment"),os=require("os"),path=require("path"),port=process.env.port||5002,app=express();app.set("view engine","ejs"),app.use(express.json()),app.use(express.urlencoded({extended:!0})),app.use(express.static("public")),app.use("/css",express.static(__dirname+"p"));let jsonData=[],TraceData=[];function createPromise(s){return new Promise((a,t)=>{let r=e("firsttest1.js"),o="";r.send(s),r.on("message",e=>{console.log("Received message from child process:",e),e&&(console.log("message"),o=e)}),r.on("exit",e=>{console.log(`Child Process Exited with Code ${e}`),a(o)})})}async function loadData(e){try{let s=await fs.readFile(e,"utf8"),a=JSON.parse(s);return a}catch(t){throw console.error(`Error: ${t}`),Error(t)}}app.get("/",(e,s)=>{s.render("form",{jsonData,TraceData})}),app.post("/",async(e,s)=>{try{jsonData=[],TraceData=[];var a=e.body.key;try{var t=await axios.get("https://projectservices.onrender.com/users")}catch(r){alert("Something went wrong."),s.redirect("/")}console.log(t.data.Users),t=t.data[0].Users;for(var o=!1,n=0;n<t.length;n++)a==t[n]&&(o=!0);if(o){var c=e.body.path;c=c.replace(/^"|"$/g,"");let i=await loadData(c);jsonData=i,console.log(jsonData)}s.redirect("/")}catch(p){s.redirect("/")}}),app.post("/runScript",async(e,s)=>{TraceData=[];var a=[];jsonData.forEach(e=>{var s=[];s.push(e.id),s.push(e.password),a.push(s)});var t=a;try{var r=await axios.get("https://projectservices.onrender.com/data")}catch(o){s.send("Something went wrong.")}if(r=r.data[0].access,console.log(r),"Granted"!=r)console.log("***********"),s.send("Access Denied : Contact Ridham.");else if(t.length<1)s.send("Load some ids..");else{var n=Math.max(Math.ceil(t.length/5),1),c=[];for(let i=0;i<t.length;i+=n)c.push(createPromise(t.slice(i,i+n)));Promise.all(c).then(e=>{console.log(e);var a=[];for(let t=0;t<e.length;t++)a.push(...e[t]);console.log(a),s.send(a)})}}),app.post("/runScriptSingleElement",async(s,a)=>{TraceData=[];var t=[];s.body.forEach(e=>{var s=[];s.push(e.id),s.push(e.password),t.push(s)});var r=t;try{var o=await axios.get("https://projectservices.onrender.com/data")}catch(n){a.send("Something went wrong.")}if(o=o.data[0].access,console.log(o),"Granted"!=o)console.log("***********"),a.send("Access Denied : Contact Ridham.");else if(r.length<1)a.send("Load some ids..");else{let c=e("firsttest1.js"),i="";c.send(r),c.on("message",e=>{console.log("Received message from child process:",e),e&&(console.log("message"),i=e)}),c.on("exit",e=>{console.log(`Child Process Exited with Code ${e}`),a.send(i)})}}),app.post("/refresh",async(e,s)=>{jsonData=[],TraceData=[],s.redirect("/")}),app.listen(port,()=>{console.log(`Server is running at http://localhost:${port}`)});